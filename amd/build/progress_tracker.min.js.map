{"version":3,"file":"progress_tracker.min.js","sources":["../src/progress_tracker.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AJAX progress tracker for bulk messaging history page.\n *\n * @module     tool_bulkmessaging/progress_tracker\n * @copyright  2026 Moddaker\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {call as fetchMany} from 'core/ajax';\nimport Log from 'core/log';\n\nconst POLL_INTERVAL = 3000;\nconst TERMINAL_STATUSES = [2, 3, 4, 5];\n\n/**\n * Fetch progress for a single log entry.\n *\n * @param {number} logid\n * @returns {Promise}\n */\nconst getProgress = (logid) => fetchMany([{\n    methodname: 'tool_bulkmessaging_get_message_progress',\n    args: {logid},\n}])[0];\n\n/**\n * Update the DOM for a single row.\n *\n * @param {number} logid\n * @param {object} data\n */\nconst updateRow = (logid, data) => {\n    // Update status badge.\n    const statusEl = document.getElementById('bmsg-status-' + logid);\n    if (statusEl) {\n        statusEl.className = data.statusclass;\n        statusEl.textContent = data.statuslabel;\n    }\n\n    // Update progress bar and counts.\n    const progressEl = document.getElementById('bmsg-progress-' + logid);\n    if (progressEl) {\n        const bar = progressEl.querySelector('.progress-bar');\n        if (bar) {\n            bar.style.width = data.percentage + '%';\n            bar.setAttribute('aria-valuenow', data.percentage);\n        }\n\n        const countsEl = progressEl.querySelector('.bmsg-counts');\n        if (countsEl) {\n            let text = data.sentcount.toString();\n            if (data.failedcount > 0) {\n                text += ' / ' + data.failedcount + ' failed';\n            }\n            text += ' (' + data.percentage + '%)';\n            countsEl.textContent = text;\n        }\n\n        // Show progress bar if status moved from queued to processing.\n        if (data.status !== 0) {\n            const progressWrap = progressEl.querySelector('.progress');\n            if (progressWrap) {\n                progressWrap.style.display = '';\n            }\n            const countsWrap = progressEl.querySelector('.bmsg-counts');\n            if (countsWrap) {\n                countsWrap.style.display = '';\n            }\n        }\n    }\n\n    // Update action icons.\n    const actionsEl = document.getElementById('bmsg-actions-' + logid);\n    if (actionsEl) {\n        // Hide cancel button if no longer queued.\n        const cancelBtn = actionsEl.querySelector('[data-action=\"cancel\"]');\n        if (cancelBtn) {\n            cancelBtn.style.display = (data.status === 0) ? '' : 'none';\n        }\n        // Show stop button if processing.\n        const stopBtn = actionsEl.querySelector('[data-action=\"stop\"]');\n        if (stopBtn) {\n            stopBtn.style.display = (data.status === 1) ? '' : 'none';\n        }\n        // Show start button if failed or stopped.\n        const startBtn = actionsEl.querySelector('[data-action=\"start\"]');\n        if (startBtn) {\n            startBtn.style.display = (data.status === 3 || data.status === 5) ? '' : 'none';\n        }\n        // Show delete button if terminal.\n        const deleteBtn = actionsEl.querySelector('[data-action=\"delete\"]');\n        if (deleteBtn) {\n            deleteBtn.style.display = TERMINAL_STATUSES.includes(data.status) ? '' : 'none';\n        }\n    }\n};\n\n/**\n * Start polling for a set of active log IDs.\n *\n * @param {number[]} logids\n */\nconst startPolling = (logids) => {\n    const activeIds = new Set(logids);\n\n    const poll = () => {\n        if (activeIds.size === 0) {\n            return;\n        }\n\n        const promises = [];\n        for (const logid of activeIds) {\n            promises.push(\n                getProgress(logid)\n                    .then((data) => {\n                        updateRow(logid, data);\n                        if (TERMINAL_STATUSES.includes(data.status)) {\n                            activeIds.delete(logid);\n                        }\n                    })\n                    .catch((err) => {\n                        Log.error('Progress tracker error for log ' + logid + ': ' + err);\n                        activeIds.delete(logid);\n                    })\n            );\n        }\n\n        Promise.all(promises).then(() => {\n            if (activeIds.size > 0) {\n                setTimeout(poll, POLL_INTERVAL);\n            }\n        });\n    };\n\n    setTimeout(poll, POLL_INTERVAL);\n};\n\n/**\n * Initialise progress tracking.\n *\n * @param {number[]} activeLogIds - Array of log IDs with status 0 or 1.\n */\nexport const init = (activeLogIds) => {\n    if (!activeLogIds || activeLogIds.length === 0) {\n        return;\n    }\n    startPolling(activeLogIds);\n};\n"],"names":["TERMINAL_STATUSES","getProgress","logid","methodname","args","updateRow","data","statusEl","document","getElementById","className","statusclass","textContent","statuslabel","progressEl","bar","querySelector","style","width","percentage","setAttribute","countsEl","text","sentcount","toString","failedcount","status","progressWrap","display","countsWrap","actionsEl","cancelBtn","stopBtn","startBtn","deleteBtn","includes","activeLogIds","length","logids","activeIds","Set","poll","size","promises","push","then","delete","catch","err","error","Promise","all","setTimeout","startPolling"],"mappings":";;;;;;;0IA2BMA,kBAAoB,CAAC,EAAG,EAAG,EAAG,GAQ9BC,YAAeC,QAAU,cAAU,CAAC,CACtCC,WAAY,0CACZC,KAAM,CAACF,MAAAA,UACP,GAQEG,UAAY,CAACH,MAAOI,cAEhBC,SAAWC,SAASC,eAAe,eAAiBP,OACtDK,WACAA,SAASG,UAAYJ,KAAKK,YAC1BJ,SAASK,YAAcN,KAAKO,mBAI1BC,WAAaN,SAASC,eAAe,iBAAmBP,UAC1DY,WAAY,OACNC,IAAMD,WAAWE,cAAc,iBACjCD,MACAA,IAAIE,MAAMC,MAAQZ,KAAKa,WAAa,IACpCJ,IAAIK,aAAa,gBAAiBd,KAAKa,mBAGrCE,SAAWP,WAAWE,cAAc,mBACtCK,SAAU,KACNC,KAAOhB,KAAKiB,UAAUC,WACtBlB,KAAKmB,YAAc,IACnBH,MAAQ,MAAQhB,KAAKmB,YAAc,WAEvCH,MAAQ,KAAOhB,KAAKa,WAAa,KACjCE,SAAST,YAAcU,QAIP,IAAhBhB,KAAKoB,OAAc,OACbC,aAAeb,WAAWE,cAAc,aAC1CW,eACAA,aAAaV,MAAMW,QAAU,UAE3BC,WAAaf,WAAWE,cAAc,gBACxCa,aACAA,WAAWZ,MAAMW,QAAU,WAMjCE,UAAYtB,SAASC,eAAe,gBAAkBP,UACxD4B,UAAW,OAELC,UAAYD,UAAUd,cAAc,0BACtCe,YACAA,UAAUd,MAAMW,QAA2B,IAAhBtB,KAAKoB,OAAgB,GAAK,cAGnDM,QAAUF,UAAUd,cAAc,wBACpCgB,UACAA,QAAQf,MAAMW,QAA2B,IAAhBtB,KAAKoB,OAAgB,GAAK,cAGjDO,SAAWH,UAAUd,cAAc,yBACrCiB,WACAA,SAAShB,MAAMW,QAA2B,IAAhBtB,KAAKoB,QAAgC,IAAhBpB,KAAKoB,OAAgB,GAAK,cAGvEQ,UAAYJ,UAAUd,cAAc,0BACtCkB,YACAA,UAAUjB,MAAMW,QAAU5B,kBAAkBmC,SAAS7B,KAAKoB,QAAU,GAAK,wBAkDhEU,eACZA,cAAwC,IAAxBA,aAAaC,QAzChBC,CAAAA,eACZC,UAAY,IAAIC,IAAIF,QAEpBG,KAAO,QACc,IAAnBF,UAAUG,kBAIRC,SAAW,OACZ,MAAMzC,SAASqC,UAChBI,SAASC,KACL3C,YAAYC,OACP2C,MAAMvC,OACHD,UAAUH,MAAOI,MACbN,kBAAkBmC,SAAS7B,KAAKoB,SAChCa,UAAUO,OAAO5C,UAGxB6C,OAAOC,mBACAC,MAAM,kCAAoC/C,MAAQ,KAAO8C,KAC7DT,UAAUO,OAAO5C,WAKjCgD,QAAQC,IAAIR,UAAUE,MAAK,KACnBN,UAAUG,KAAO,GACjBU,WAAWX,KAtHL,SA2HlBW,WAAWX,KA3HO,MAuIlBY,CAAajB"}